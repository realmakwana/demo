@page "/user-rights"
@using TransportERP.Models.Entities
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.DropDowns
@using TransportERP.Models.DTOs
@using ERP.Components.Shared.UI

<Breadcrumb Items="@breadcrumbItems" />

<div class="grid-container fade-in">
    <div class="grid-header">
        <div class="grid-title-container">
            <h3 class="grid-title">User Menu Rights</h3>
            <InfoTooltip Text="Configure module access and action permissions for users" />
        </div>
    </div>

    <!-- User Selection and Actions -->
    <div class="toolbar-section">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Select User</label>
                <SfDropDownList TValue="int" 
                                TItem="UserDto" 
                                @bind-Value="selectedUserId"
                                DataSource="@users" 
                                Placeholder="-- Select User --"
                                ShowClearButton="true"
                                PopupHeight="300px">
                    <DropDownListFieldSettings Value="UserID" Text="UserName"></DropDownListFieldSettings>
                    <DropDownListTemplates TItem="UserDto">
                        <ItemTemplate>
                            <div class="user-dropdown-item">
                                <div class="user-name">@context.UserName</div>
                                <div class="user-email">@context.EmailID</div>
                            </div>
                        </ItemTemplate>
                    </DropDownListTemplates>
                    <DropDownListEvents TValue="int" TItem="UserDto" ValueChange="OnUserSelectedAsync"></DropDownListEvents>
                </SfDropDownList>
            </div>
            
            <div class="col-md-8">
                @if (selectedUserId > 0)
                {
                    <div class="grid-actions">
                        <SfButton CssClass="e-outline e-info" 
                                  IconCss="bi bi-check-square" 
                                  OnClick="@(() => SetAllRights(true))">
                            Select All
                        </SfButton>
                        <SfButton CssClass="e-outline e-warning" 
                                  IconCss="bi bi-x-circle" 
                                  OnClick="@(() => SetAllRights(false))">
                            Clear All
                        </SfButton>
                        <SfButton CssClass="e-success" 
                                  IconCss="bi bi-save" 
                                  OnClick="SaveRights" 
                                  Disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Save Rights
                        </SfButton>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Grid Section -->
    @if (selectedUserId > 0)
    {
        <SfGrid @ref="grid" 
                DataSource="@menuRights" 
                AllowPaging="true"
                AllowSorting="true"
                AllowFiltering="true"
                Toolbar="@(new List<string>() { "Search" })">
            
            <GridPageSettings PageSize="20" PageSizes="new int[] { 10, 20, 50, 100 }"></GridPageSettings>
            <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
            
            <GridColumns>
                <GridColumn Field="@nameof(MenuRightsDto.MenuDispName)" 
                            HeaderText="Menu / Module" 
                            Width="250">
                    <Template>
                        @{
                            var item = context as MenuRightsDto;
                            <div class="@(item.ParentMenuID == 0 ? "fw-bold" : "ps-4 text-muted")">
                                @item.MenuDispName
                            </div>
                        }
                    </Template>
                </GridColumn>

                <GridColumn Field="@nameof(MenuRightsDto.IsShow)" 
                            HeaderText="Show" 
                            Width="100" 
                            TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var item = context as MenuRightsDto;
                            <SfCheckBox @bind-Checked="item.IsShow" TChecked="bool"></SfCheckBox>
                        }
                    </Template>
                </GridColumn>

                <GridColumn Field="@nameof(MenuRightsDto.IsAdd)" 
                            HeaderText="Add" 
                            Width="100" 
                            TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var item = context as MenuRightsDto;
                            if (item.ParentMenuID != 0)
                            {
                                <SfCheckBox @bind-Checked="item.IsAdd" TChecked="bool"></SfCheckBox>
                            }
                        }
                    </Template>
                </GridColumn>

                <GridColumn Field="@nameof(MenuRightsDto.IsEdit)" 
                            HeaderText="Edit" 
                            Width="100" 
                            TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var item = context as MenuRightsDto;
                            if (item.ParentMenuID != 0)
                            {
                                <SfCheckBox @bind-Checked="item.IsEdit" TChecked="bool"></SfCheckBox>
                            }
                        }
                    </Template>
                </GridColumn>

                <GridColumn Field="@nameof(MenuRightsDto.IsDelete)" 
                            HeaderText="Delete" 
                            Width="100" 
                            TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var item = context as MenuRightsDto;
                            if (item.ParentMenuID != 0)
                            {
                                <SfCheckBox @bind-Checked="item.IsDelete" TChecked="bool"></SfCheckBox>
                            }
                        }
                    </Template>
                </GridColumn>

                <GridColumn Field="@nameof(MenuRightsDto.IsExport)" 
                            HeaderText="Export" 
                            Width="100" 
                            TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var item = context as MenuRightsDto;
                            if (item.ParentMenuID != 0)
                            {
                                <SfCheckBox @bind-Checked="item.IsExport" TChecked="bool"></SfCheckBox>
                            }
                        }
                    </Template>
                </GridColumn>

                <GridColumn Field="@nameof(MenuRightsDto.IsVerify)" 
                            HeaderText="Verify" 
                            Width="100" 
                            TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var item = context as MenuRightsDto;
                            if (item.ParentMenuID != 0)
                            {
                                <SfCheckBox @bind-Checked="item.IsVerify" TChecked="bool"></SfCheckBox>
                            }
                        }
                    </Template>
                </GridColumn>

                <GridColumn Field="@nameof(MenuRightsDto.IsPrint)" 
                            HeaderText="Print" 
                            Width="100" 
                            TextAlign="TextAlign.Center">
                    <Template>
                        @{
                            var item = context as MenuRightsDto;
                            if (item.ParentMenuID != 0)
                            {
                                <SfCheckBox @bind-Checked="item.IsPrint" TChecked="bool"></SfCheckBox>
                            }
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
        </SfGrid>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-state-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <h3>Please Select a User</h3>
            <p>Choose a user from the dropdown above to manage their module permissions.</p>
        </div>
    }
</div>

<style>
    .toolbar-section {
        padding: 1.5rem;
        background: white;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 0;
    }

    .user-dropdown-item {
        padding: 0.25rem 0;
    }

    .user-name {
        font-weight: 600;
        color: #212529;
        font-size: 0.95rem;
    }

    .user-email {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.125rem;
    }

    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        color: #6c757d;
        background: #f8f9fa;
        margin: 1.5rem;
        border-radius: 8px;
    }

    .empty-state-icon {
        margin-bottom: 1.5rem;
        color: #dee2e6;
    }

    .empty-state h3 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #6c757d;
        font-size: 0.95rem;
    }

    .fw-bold {
        font-weight: 600;
        color: #0f172a;
    }

    .ps-4 {
        padding-left: 1.5rem;
    }

    .text-muted {
        color: #6c757d;
    }
</style>
