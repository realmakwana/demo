@page "/invoices"
@using TransportERP.Models.DTOs

<PageTitle>Invoices - Transport ERP</PageTitle>

<TransactionPage THeader="InvoiceDto" 
                 TLineItem="InvoiceItemDto"
                      Title="Invoice"
                      Subtitle="Manage customer invoices"
                      GridTitle="All Invoices"
                      LineItemsTitle="Invoice Items"
                      DataSource="@invoices"
                      TotalRecordsInDatabase="50"
                      OnSave="SaveInvoice"
                      OnDelete="DeleteInvoice"
                      OnLineItemAdded="HandleLineItemAdded"
                      OnLineItemRemoved="HandleLineItemRemoved"
                      GetLineItems="@(inv => inv.Items)"
                      HelpText="Create and manage complex invoices with multiple line items. This master-detail interface allows for granular control over individual billing items. Try exporting with custom range to see dummy data generation!"
                      @ref="crudPage">
    
    <GridColumns>
        <GridColumn Field="@nameof(InvoiceDto.InvoiceNumber)" HeaderText="Invoice #" Width="120"></GridColumn>
        <GridColumn Field="@nameof(InvoiceDto.InvoiceDate)" HeaderText="Date" Width="120" Format="dd MMM yyyy"></GridColumn>
        <GridColumn Field="@nameof(InvoiceDto.CustomerName)" HeaderText="Customer" Width="200"></GridColumn>
        <GridColumn Field="@nameof(InvoiceDto.TotalAmount)" HeaderText="Amount" Width="120" Format="C2" TextAlign="TextAlign.Right"></GridColumn>
    </GridColumns>

    <HeaderFormContent>
        <div class="form-row">
            <div class="form-group">
                <SfTextBox @bind-Value="currentInvoice.InvoiceNumber" Placeholder="Invoice Number" FloatLabelType="FloatLabelType.Auto" CssClass="e-outline" ValidateOnInput="true"></SfTextBox>
                <ValidationMessage For="@(() => currentInvoice.InvoiceNumber)" />
            </div>
            <div class="form-group">
                <SfDatePicker @bind-Value="currentInvoice.InvoiceDate" Placeholder="Invoice Date" FloatLabelType="FloatLabelType.Auto" CssClass="e-outline"></SfDatePicker>
                <ValidationMessage For="@(() => currentInvoice.InvoiceDate)" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <AutoSuggestBox @bind-Value="currentInvoice.CustomerName" Placeholder="Customer Name" FloatLabelType="FloatLabelType.Auto" SearchFunction="SearchCustomers"></AutoSuggestBox>
                <ValidationMessage For="@(() => currentInvoice.CustomerName)" />
            </div>
            <div class="form-group">
                <SfTextBox @bind-Value="currentInvoice.CustomerPhone" Placeholder="Phone Number" FloatLabelType="FloatLabelType.Auto" CssClass="e-outline" ValidateOnInput="true"></SfTextBox>
                <ValidationMessage For="@(() => currentInvoice.CustomerPhone)" />
            </div>
            <div class="form-group">
                <SfTextBox @bind-Value="currentInvoice.CustomerEmail" Placeholder="Email Address" FloatLabelType="FloatLabelType.Auto" CssClass="e-outline" ValidateOnInput="true"></SfTextBox>
                <ValidationMessage For="@(() => currentInvoice.CustomerEmail)" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
                <SfTextBox @bind-Value="currentInvoice.CustomerAddress" Placeholder="Customer Address" FloatLabelType="FloatLabelType.Auto" Multiline="true" CssClass="e-outline" ValidateOnInput="true"></SfTextBox>
                <ValidationMessage For="@(() => currentInvoice.CustomerAddress)" />
            </div>
        </div>
    </HeaderFormContent>

    <LineItemFormContent>
        <div class="inline-form-row">
            <div class="inline-form-field">
                <SfTextBox @bind-Value="newItem.ItemName" Placeholder="Item Name" FloatLabelType="FloatLabelType.Auto" CssClass="e-outline"></SfTextBox>
            </div>
            <div class="inline-form-field">
                <SfTextBox @bind-Value="newItem.Description" Placeholder="Description" FloatLabelType="FloatLabelType.Auto" CssClass="e-outline"></SfTextBox>
            </div>
            <div class="inline-form-field">
                <SfDropDownList TValue="string" TItem="string" @bind-Value="newItem.Category" DataSource="@categories" Placeholder="Category" FloatLabelType="FloatLabelType.Auto" AllowFiltering="true" CssClass="e-outline"></SfDropDownList>
            </div>
            <div class="inline-form-field" style="max-width: 100px;">
                <SfNumericTextBox @bind-Value="newItem.Quantity" Placeholder="Qty" FloatLabelType="FloatLabelType.Auto" Min="1" Format="N0" CssClass="e-outline"></SfNumericTextBox>
            </div>
            <div class="inline-form-field" style="max-width: 130px;">
                <SfNumericTextBox @bind-Value="newItem.UnitPrice" Placeholder="Unit Price" FloatLabelType="FloatLabelType.Auto" Format="C2" CssClass="e-outline"></SfNumericTextBox>
            </div>
        </div>
    </LineItemFormContent>

    <LineItemGridColumns>
        <GridColumn Field="@nameof(InvoiceItemDto.ItemName)" HeaderText="Item Name" Width="200"></GridColumn>
        <GridColumn Field="@nameof(InvoiceItemDto.Description)" HeaderText="Description" Width="250"></GridColumn>
        <GridColumn Field="@nameof(InvoiceItemDto.Category)" HeaderText="Category" Width="120"></GridColumn>
        <GridColumn Field="@nameof(InvoiceItemDto.Quantity)" HeaderText="Qty" Width="80" TextAlign="TextAlign.Right"></GridColumn>
        <GridColumn Field="@nameof(InvoiceItemDto.UnitPrice)" HeaderText="Unit Price" Format="C2" Width="120" TextAlign="TextAlign.Right"></GridColumn>
        <GridColumn Field="@nameof(InvoiceItemDto.Amount)" HeaderText="Amount" Format="C2" Width="120" TextAlign="TextAlign.Right"></GridColumn>
    </LineItemGridColumns>

    <TotalsContent>
        <div class="invoice-totals">
            <div class="total-row">
                <span>Subtotal:</span>
                <span>@CalculateSubtotal().ToString("C2")</span>
            </div>
            <div class="total-row">
                <span>Tax (18%):</span>
                <span>@CalculateTax().ToString("C2")</span>
            </div>
            <div class="total-row total-final">
                <span><strong>Total:</strong></span>
                <span><strong>@CalculateTotal().ToString("C2")</strong></span>
            </div>
        </div>
    </TotalsContent>
</TransactionPage>
