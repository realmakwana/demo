@page "/invoices"
@using ERP.Models.Entities
@using ERP.Components.Shared.Grid
@using ERP.Components.Shared.UI
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Grids

<PageTitle>Invoices - Transport ERP</PageTitle>

<div class="page-container">
    <!-- Breadcrumb -->
    <Breadcrumb Items="@breadcrumbItems" />

    <!-- Manual Form Section -->
    @if (showForm && currentInvoice != null)
    {
        <div class="form-container fade-in">
            <div class="form-header">
                <h3>@(currentInvoice.InvoiceID == 0 ? "Create New Invoice" : "Edit Invoice")</h3>
            </div>

            <EditForm Model="@currentInvoice" OnValidSubmit="SaveInvoice">
                <DataAnnotationsValidator />
                
                <div class="section-title">Invoice Header</div>
                <div class="row g-4 mb-4">
                    <!-- Invoice Number -->
                    <div class="col-md-4">
                        <SfTextBox @bind-Value="currentInvoice.invoice_no" 
                                   Placeholder="Invoice Number *"
                                   FloatLabelType="FloatLabelType.Auto"
                                   CssClass="e-outline">
                        </SfTextBox>
                        <ValidationMessage For="@(() => currentInvoice.invoice_no)" />
                    </div>

                    <!-- Invoice Date -->
                    <div class="col-md-4">
                        <SfDatePicker TValue="DateTime" @bind-Value="currentInvoice.invoice_date" 
                                     Placeholder="Invoice Date *"
                                     FloatLabelType="FloatLabelType.Auto"
                                     CssClass="e-outline">
                        </SfDatePicker>
                        <ValidationMessage For="@(() => currentInvoice.invoice_date)" />
                    </div>

                    <!-- Customer -->
                    <div class="col-md-4">
                        <SfDropDownList TValue="int" TItem="Customer" @bind-Value="currentInvoice.CustomerID" 
                                       DataSource="@customers" 
                                       Placeholder="Select Customer *"
                                       FloatLabelType="FloatLabelType.Auto"
                                       CssClass="e-outline">
                            <DropDownListFieldSettings Value="CustomerID" Text="CustomerName"></DropDownListFieldSettings>
                        </SfDropDownList>
                        <ValidationMessage For="@(() => currentInvoice.CustomerID)" />
                    </div>
                </div>

                <div class="section-title">Invoice Items</div>
                <!-- Line Item Entry Form -->
                <div class="line-item-entry p-3 mb-3 border rounded bg-light">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <SfTextBox @bind-Value="newItem.item_name" Placeholder="Item Name" FloatLabelType="FloatLabelType.Auto" CssClass="e-outline"></SfTextBox>
                        </div>
                        <div class="col-md-3">
                            <SfTextBox @bind-Value="newItem.remarks" Placeholder="Remarks" FloatLabelType="FloatLabelType.Auto" CssClass="e-outline"></SfTextBox>
                        </div>
                        <div class="col-md-1">
                            <SfNumericTextBox TValue="int" @bind-Value="newItem.qty" Placeholder="Qty" FloatLabelType="FloatLabelType.Auto" Min="1" CssClass="e-outline"></SfNumericTextBox>
                        </div>
                        <div class="col-md-2">
                            <SfNumericTextBox TValue="decimal" @bind-Value="newItem.rate" Placeholder="Rate" FloatLabelType="FloatLabelType.Auto" Format="C2" CssClass="e-outline"></SfNumericTextBox>
                        </div>
                        <div class="col-md-1">
                            <SfNumericTextBox TValue="decimal" @bind-Value="newItem.discount" Placeholder="Disc" FloatLabelType="FloatLabelType.Auto" Format="C2" CssClass="e-outline"></SfNumericTextBox>
                        </div>
                        <div class="col-md-1">
                            <SfButton CssClass="@(newItem.LineItemID > 0 || !string.IsNullOrEmpty(newItem.item_name) && currentInvoiceItems.Any(i => i.item_name == newItem.item_name) ? "e-info w-100" : "e-primary w-100")" 
                                      IconCss="@(newItem.LineItemID > 0 ? "bi bi-check-all" : "bi bi-plus")" 
                                      OnClick="AddLineItem" 
                                      Type="button">
                                @(newItem.LineItemID > 0 ? "Update" : "Add")
                            </SfButton>
                        </div>
                    </div>
                </div>

                <!-- Line Items Table -->
                <div class="table-responsive mb-4">
                    <table class="table table-hover border">
                        <thead class="bg-light">
                            <tr>
                                <th>Item</th>
                                <th>Remarks</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Rate</th>
                                <th class="text-end">Discount</th>
                                <th class="text-end">Amount</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!currentInvoiceItems.Any())
                            {
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-3">No items added yet.</td>
                                </tr>
                            }
                            @foreach (var item in currentInvoiceItems)
                            {
                                <tr>
                                    <td>@item.item_name</td>
                                    <td>@item.remarks</td>
                                    <td class="text-end">@item.qty</td>
                                    <td class="text-end">@item.rate.ToString("C2")</td>
                                    <td class="text-end">@item.discount.ToString("C2")</td>
                                    <td class="text-end">@item.amount.ToString("C2")</td>
                                    <td class="text-center">
                                         <div class="d-flex justify-content-center gap-2">
                                            <SfButton CssClass="e-info e-small e-outline"
                                                      IconCss="bi bi-pencil"
                                                      OnClick="@(() => EditLineItem(item))"
                                                      Type="button"
                                                      Title="Edit Item">
                                            </SfButton>
                                        <SfButton CssClass="e-danger e-small e-outline" IconCss="bi bi-trash" OnClick="@(() => RemoveLineItem(item))" Type="button"></SfButton>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Totals Section -->
                <div class="row justify-content-end">
                    <div class="col-md-4">
                        <div class="totals-card p-3 border rounded">
                            <div class="d-flex justify-content-between h5 mb-0">
                                <strong>Total:</strong>
                                <strong>@CalculateTotal().ToString("C2")</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sticky-footer">
                    <SfButton CssClass="e-primary" IconCss="bi bi-save" Type="Submit">
                        @(currentInvoice.InvoiceID == 0 ? "Save Invoice" : "Update Invoice")
                    </SfButton>
                    <SfButton CssClass="e-outline" OnClick="CloseForm" Type="button">
                        Cancel
                    </SfButton>
                </div>
            </EditForm>
        </div>
    }

    <!-- Common Grid -->
    @if (!showForm)
    {
        <CommonGrid TEntity="Invoice"
                    GridTitle="All Invoices"
                    EntityName="Invoice"
                    HelpText="Manage customer invoices and billing history."
                    DataSource="@invoices"
                    CanAdd="@(currentRights?.IsAdd ?? true)"
                    CanEdit="@(currentRights?.IsEdit ?? true)"
                    CanDelete="@(currentRights?.IsDelete ?? true)"
                    OnAdd="OpenAddForm"
                    OnEdit="OpenEditForm"
                    OnDelete="DeleteInvoice">
            <GridColumns>
                <GridColumn Field="@nameof(Invoice.InvoiceID)" HeaderText="ID" Width="80" Visible="false" IsPrimaryKey="true"></GridColumn>
                <GridColumn Field="@nameof(Invoice.invoice_no)" HeaderText="Invoice" Width="150"></GridColumn>
                <GridColumn Field="@nameof(Invoice.invoice_date)" HeaderText="Date" Width="120" Format="d"></GridColumn>
                <GridColumn Field="@nameof(Invoice.CustomerID)" HeaderText="Customer ID" Width="120"></GridColumn>
                <GridColumn HeaderText="Items" Width="100">
                    <Template>
                        @{
                            var invoice = context as Invoice;
                            <span class="badge bg-info">@(invoice?.Items?.Count ?? 0) items</span>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
        </CommonGrid>
    }
</div>
